<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Thu Nov 30 18:10:54 2006 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>2006 Perl Advent Calendar: Santa's Dilemna</title>
<link rel="stylesheet" href="../style.css" type="text/css" /></head>
<body>
<h1><a href="../">Perl Advent Calendar 2006-12</a>-24</h1>
<h2 align="center">Santa's Dilemna</h2>
<h3 align="center">by Ben Prew</h3>

<p>
  Kris Kringle had just left the North Pole on his brand-new state-of-the-art
  sleigh, complete with wireless access to the North Pole presents database.
  The elves had been hard at work bringing present distribution into the 21st
  century, and their finishing touch was getting rid of Santa's old, outdated
  hand-written list. The who-is-naughty, who-is-nice, and who-wants-what lists
  were now stored in a fancy new Oracle(!) database. (Yes, Oracle got off the
  naughty list with that one)
</p>
<p>
  Everything was going swimmingly and Kris was picking, packing and delivering
  more presents then ever (Which is a good thing, considering our "conversion"
  program currently going on in Iraq). Unfortunately, just as he was sweeping
  into Russia, a black-bellied plover slammed into the side of the sleigh!
  Kris looked over the side and to his horror, a smoking hole was all that
  remained of his wireless link to the North Pole. A crackling on the radio
  brought Kris back to his senses. It was Rudolph, his main reindeer.
</p>
  <blockquote>"Captain, what was that?"</blockquote>
  <blockquote>"Rudy, we just got groused and lost our NP link."</blockquote>
  <blockquote>"KGB?"</blockquote>
  <blockquote>"Uhh&hellip; I don't think so."</blockquote>
<p>
  Rudolph was a huge conspiracy theory freak, and of course since they were
  over Russia, it could only be the KGB trying to sabotage Kris. They were
  trying to enact a "regime change", at least according to the reindeer.
</p>
<p>
  Kris began rooting through his system, looking for a second chance&hellip;
  anything&hellip;.
</p>
<p>
  Any sort of land line connection&hellip; no<br>
  Cell-phone card&hellip; not even Verizon has that much coverage&hellip;.<br>
  Tin-foil to make an improvised antenna from the reindeers antlers&hellip;. no
</p>
<p>
  Wait, wait&hellip; maybe this was something&hellip;.
</p>
<p>
  Kris realized that Norrish, his head elf, had been using his laptop to munge
  the wish list before importing it into the new database, and the raw text
  files were still sitting on his hard drive! Unfortunately, Kris didn't have
  time to install Oracle, much less the horsepower to run the database and
  import the data. He slumped back in his seat, slowly coming to terms with
  what this meant. Just as he was about to turn the sleigh around, Rudolph's
  nose lit up&hellip;
</p>
<blockquote>"What is it boy, what are you thinking?"</blockquote>
<p>
  Rudolph started wagging his tail excitedly (yes, reindeer have tails), and
  began jostling up and down, braying and making other reindeer noises.
</p>
<blockquote>
  "Come on Rudy, you know I can't understand you when you're this excited.
  Slow down, take a deep breath and try again"
</blockquote>
<p>
  Rudolph inhaled deeply, exhaled, and then quitely, calmly uttered four
  meager syllables,
</p>
<blockquote>"Any data?"</blockquote>
<p>
  Kris stared at Rudolph blankly, not quite sure what to make of what was just
  said. What in the blazes did that mean? Out of ideas, but with little else to
  do over the vast Siberian wasteland, Kris focused all his Kringle energies
  and attempted to decode his companion's cryptic quip.
</p>
<p>
  He scanned his memory, trying to dig up something, anything at all.
  Something nagged at the back of his mind, he could feel it, but he just
  couldn't mold it into a coherent thought. Suddenly, his eyes lit up, and
  quick as a wink Kris knew what Rudolph meant. The code began pouring from his
  fingers onto the screen as Kris entered the zone. His eyes narrowed as all
  other thoughts were put aside, as he intently focused on the task at hand.
</p>
<blockquote>
  "Where were those files&hellip; in Norrish's home directory of course"
</blockquote>
<blockquote>"Now, the sql queries"</blockquote>
<p>
  With furious typing, a little elf magic and much unit testing (You know he
  rolls with XP), Kris had solved his problems and saved Christmas. Before you
  scroll down to the code, can you guess what characters his keyboard had
  expressed? What masterpiece he was able to piece together in a few short
  minutes, with only raw text files, and but a word from his most trusted
  reindeer? Behold, the code of Kris Kringle!
</p>

<h1><a href="mod24.pl">mod24.pl</a> - Kringle's Code</h1>
<hr />
<!-- contents of filename: kringle.pl -->
<pre>
   1 #!/usr/bin/perl
   2 
   3 <span class="k">use</span> <span class="w">DBI</span><span class="sc">;</span>
   4 
   5 <span class="c"># My files are laid out like this:</span>
   6 <span class="c">#</span>
   7 <span class="c">#</span> <a href="presents.txt"><span class="c">presents.txt</span></a>
   8 <span class="c"># person_no|present</span>
   9 <span class="c"># 1|bicycle</span>
  10 <span class="c"># 1|action figure</span>
  11 <span class="c"># 2|doll</span>
  12 <span class="c"># 3|doll</span>
  13 <span class="c"># 4|bicycle</span>
  14 <span class="c">#</span>
  15 <span class="c">#</span> <a href="people.txt"><span class="c">people.txt</span></a>
  16 <span class="c"># person_no|name|personality|address</span>
  17 <span class="c"># 1|bob smith|nice|123 anywhere st, St. Petersburg</span>
  18 <span class="c"># 2|alice andrews|nice|465 somewhere st, Moscow</span>
  19 <span class="c"># 3|frank martonick|naughty|1138 lenin ave, St. Petersburg</span>
  20 <span class="c"># 4|billy cutter|nice|31337 peoples lane, Moscow</span>
  21 
  22 <span class="k">my</span> <span class="i">$dbh</span> = <span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span><span class="q">&#39;dbi:AnyData(RaiseError=&gt;1):&#39;</span><span class="s">)</span><span class="sc">;</span>
  23 
  24 <span class="i">$dbh</span><span class="i">-&gt;func</span><span class="s">(</span> <span class="q">&#39;people&#39;</span><span class="cm">,</span> <span class="q">&#39;Pipe&#39;</span><span class="cm">,</span> <span class="q">&#39;/home/norrish/lists/people.txt&#39;</span><span class="cm">,</span> <span class="q">&#39;ad_import&#39;</span><span class="s">)</span><span class="sc">;</span>
  25 <span class="i">$dbh</span><span class="i">-&gt;func</span><span class="s">(</span> <span class="q">&#39;presents&#39;</span><span class="cm">,</span> <span class="q">&#39;Pipe&#39;</span><span class="cm">,</span> <span class="q">&#39;/home/norrish/lists/presents.txt&#39;</span><span class="cm">,</span> <span class="q">&#39;ad_import&#39;</span><span class="s">)</span><span class="sc">;</span>
  26 
  27 <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="q">q/</span>
  28     <span class="q">    SELECT person_no, name, address</span>
  29       <span class="q">      FROM people</span>
  30      <span class="q">     WHERE personality = ?/</span><span class="s">)</span><span class="sc">;</span>
  31 
  32 <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="q">&#39;nice&#39;</span><span class="s">)</span><span class="sc">;</span>
  33 
  34 <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$person</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_arrayref</span> <span class="s">)</span> <span class="s">{</span>
  35     <span class="k">my</span> <span class="i">$presents</span> = <span class="i">$dbh</span><span class="i">-&gt;selectall_arrayref</span><span class="s">(</span><span class="q">q/</span>
  36         <span class="q">        SELECT present</span>
  37           <span class="q">          FROM presents</span>
  38          <span class="q">         WHERE person_no = ?/</span><span class="cm">,</span> <span class="s">{</span><span class="s">}</span><span class="cm">,</span> <span class="i">$person</span>-&gt;[<span class="n">0</span>]<span class="s">)</span><span class="sc">;</span>
  39 
  40     <span class="k">print</span> <span class="q">&quot;Presents for &quot;</span>. <span class="i">$person</span>-&gt;[<span class="n">1</span>] . <span class="q">&quot; (living at: &quot;</span>. <span class="i">$person</span>-&gt;[<span class="n">2</span>] . <span class="q">&quot;)\n\t&quot;</span><span class="cm">,</span>
  41           <span class="k">join</span><span class="s">(</span><span class="q">&quot;\n\t&quot;</span><span class="cm">,</span> <span class="k">map</span> <span class="s">{</span> <span class="k">join</span> <span class="q">&quot; &quot;</span><span class="cm">,</span> <span class="i">@$_</span> <span class="s">}</span> <span class="i">@$presents</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
  42 <span class="s">}</span>
  43 
  44 <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
</pre>

<p>
<tt><A HREF="http://search.cpan.org/search?module=DBD::AnyData">DBD::AnyData</a></tt>
is a Perl module that allows one to, among other things, use a variety of
(mostly text) file formats as tables in a database. It seems to have limited
support for joins, so I had to do the queries separately. Even so, AnyData is
really cool!</p>

</body>
</html>
